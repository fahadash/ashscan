using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace ExploitFinder
{
    using System.Windows.Input;

    using Extensibility;

    using Mono.Addins;

    [Extension]
    public class ExploitCommandsHandler : ICommandHandler
    {
        private IIrcController controller = null;
        public IEnumerable<string> Commands { get; private set; }

        internal static AddinBootstrapper bootStrapper = null;

        public ExploitCommandsHandler()
        {
            this.Commands = new[] { "bannedhost", "bannedword", "reload", "tolerance" };
            this.controller = ExtensionManager.GetController();
        }
        public void Handle(IUserInfo oper, IEnumerable<string> tokens)
        {
            var split = tokens.
                Select(t => t.Trim())
                .ToArray();

            var command = split[0];

            switch (command)
            {
                case "reload":
                    AggregateHostExploitFinder.BlackListedHostExploitFinder.Reload();
                    AggregateHostExploitFinder.BlackListedHostExploitFinder.Reload();

                    controller.Say(oper.Nick, "Lists reloaded");
                    break;
                case "bannedhost":
                    #region handle blacklist
                    if (split.Length > 2)
                    {
                        switch (split[1].ToLower())
                        {
                            case "add":
                                if (AggregateHostExploitFinder.BlackListedHostExploitFinder.Contains(split[2]))
                                {
                                    controller.Say(oper.Nick, "Host already exists.");
                                }
                                else
                                {
                                    AggregateHostExploitFinder.BlackListedHostExploitFinder.Add(split[2]);

                                    controller.Say(oper.Nick, "Host successfully added.");
                                }
                                break;

                            case "remove":
                                if (!AggregateHostExploitFinder.BlackListedHostExploitFinder.Contains(split[2]))
                                {
                                    controller.Say(oper.Nick, "Host does not exist.");
                                }
                                else
                                {
                                    AggregateHostExploitFinder.BlackListedHostExploitFinder.Remove(split[2]);

                                    controller.Say(oper.Nick, "Host successfully removed.");
                                }
                                break;
                            case "import":
                                if (bootStrapper == null)
                                {
                                    controller.Say(oper.Nick, "Failed. Bootstrapper did not run");
                                }
                                else
                                {
                                    var fileName = split[2];

                                    controller.Say(oper.Nick, bootStrapper.ImportBannedHost(fileName));
                                }
                                break;

                            case "export":
                                if (bootStrapper == null)
                                {
                                    controller.Say(oper.Nick, "Failed. Bootstrapper did not run");
                                }
                                else
                                {
                                    var fileName = split[2];

                                    controller.Say(oper.Nick, bootStrapper.ExportBannedHost(fileName));
                                }
                                break;
                            case "flush":
                                // TODO : persist this.blackListedHostExploitChecker -- Diabolic 15/03/2015
                                break;
                        }
                    }
                    #endregion
                    break;

                case "bannedword":
                    #region handle abusivenick
                    if (split.Length > 2)
                    {
                        switch (split[1])
                        {
                            case "add":
                                if (AggregateHostExploitFinder.AbusiveNickExploitFinder.Contains(split[2]))
                                {
                                    controller.Say(oper.Nick, "Word already exists.");
                                }
                                else
                                {
                                    AggregateHostExploitFinder.AbusiveNickExploitFinder.Add(split[2]);

                                    controller.Say(oper.Nick, "Word successfully added.");
                                }
                                break;

                            case "remove":
                                if (!AggregateHostExploitFinder.AbusiveNickExploitFinder.Contains(split[2]))
                                {
                                    controller.Say(oper.Nick, "Host does not exist.");
                                }
                                else
                                {
                                    AggregateHostExploitFinder.AbusiveNickExploitFinder.Remove(split[2]);

                                    controller.Say(oper.Nick, "Word successfully removed.");
                                }
                                break;
                            case "import":
                                if (bootStrapper == null)
                                {
                                    controller.Say(oper.Nick, "Failed. Bootstrapper did not run");
                                }
                                else
                                {
                                    var fileName = split[2];

                                    controller.Say(oper.Nick, bootStrapper.ImportBannedNickWords(fileName));
                                }
                                break;

                            case "export":
                                if (bootStrapper == null)
                                {
                                    controller.Say(oper.Nick, "Failed. Bootstrapper did not run");
                                }
                                else
                                {
                                    var fileName = split[2];

                                    controller.Say(oper.Nick, bootStrapper.ExportBannedNickWords(fileName));
                                }
                                break;

                            case "flush":
                                // TODO : persist this.abusiveNickExploitChecker -- Diabolic 15/03/2015
                                break;
                        }
                    }
                    #endregion
                    break;
                case "tolerance":
                    #region handle tolerance
                    if (split.Length > 1)
                    {
                        int newlevel;
                        if (!int.TryParse(split[1], out newlevel) || newlevel < 0 || newlevel > 10)
                        {
                            controller.Say(oper.Nick, string.Format("Invalid level. Choose between 0-10"));
                        }
                        else
                        {
                            AddinBootstrapper.tolerance = newlevel;
                            //Settings.Default.Save();
                            controller.Say(
                                oper.Nick,
                                string.Format("Current Tolerance level is now set to: {0}", AddinBootstrapper.tolerance));
                        }
                    }
                    else
                    {
                        controller.Say(
                            oper.Nick,
                            string.Format("Current Tolerance level is: {0}", AddinBootstrapper.tolerance));
                    }
                    #endregion
                    break;
            }

            
        }


        public bool OperatorsOnly
        {
            get
            {
                return true;
            }
        }
    }
}
