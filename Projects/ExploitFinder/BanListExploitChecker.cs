namespace ExploitFinder
{
    using System;
    using System.Collections.Generic;
    using System.IO;
    using System.Linq;

    using ExploitChecker;

    using Extensibility;

    internal abstract class BanListExploitFinder : IBanListExploitFinder
    {
        private List<string> banList;

        private string banlistFilePath;

        internal BanListExploitFinder(string banListFile)
            : base()
        {
            if (string.IsNullOrWhiteSpace(banListFile))
            {
                throw new ArgumentNullException("banListFile cannot be null or empty");
            }

            if (!File.Exists(banListFile))
            {
               throw new FileNotFoundException(banListFile);
            }

            this.banList = new List<string>();
            banlistFilePath = banListFile;

            this.ReadBanlist();

        }


        protected virtual List<string> BanList
        {
            get
            { 
                return this.banList;
            }
        }

        private void ReadBanlist()
        {
            this.banList = this.ReadFile(banlistFilePath)
                .Where(s => !string.IsNullOrWhiteSpace(s))
                .Distinct()
                .ToList();
        }

        private void WriteBanlist()
        {
            string content = string.Join("\r\n", banList);

            using (var writer = new StreamWriter(this.banlistFilePath))
            {
                writer.Write(content);
            }
        }
        private IEnumerable<string> ReadFile(string filePath)
        {
            using (var reader = new StreamReader(filePath))
            {
                var line = string.Empty;
                var templist = new List<string>();

                while ((line = reader.ReadLine()) != null)
                {
                    yield return line;
                }
            }
        }

        public abstract IEnumerable<Exploit> Run(IUserInfo user);

        public virtual bool Contains(string entry)
        {
            return this.BanList.Contains(entry);
        }

        public virtual void Add(string entry)
        {
            if (!this.Contains(entry))
            {
                this.BanList.Add(entry);
                this.WriteBanlist();
            }
        }

        public virtual void Reload()
        {
            this.ReadBanlist();
        }

        public virtual void Remove(string entry)
        {
            if (this.Contains(entry))
            {
                this.BanList.Remove(entry);
            }
        }

        public virtual IEnumerable<string> GetAll()
        {
            return this.BanList.ToArray();
        }

        public virtual void SetAll(IEnumerable<string> banList)
        {
            this.BanList.Clear();
            this.BanList.AddRange(banList);
        }
    }
}